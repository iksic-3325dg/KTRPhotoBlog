<footer class="footer">
  <span>&copy; {{ now.Year }} <a href="{{ "" | absLangURL }}">{{ site.Title }}</a></span>
</footer>

<style>
  /* フローティング検索パネル（ヘッダーを動かさない） */
  #pf-panel{
    position:fixed; z-index:9999; width:320px; max-width:calc(100vw - 24px);
    right:12px; top:72px; display:none; background:#fff; border-radius:12px;
    box-shadow:0 10px 28px rgba(0,0,0,.18); padding:12px;
  }
  #pf-panel input{ width:100%; padding:8px 10px; border:1px solid #ccc; border-radius:8px; outline:none; }
  #pf-results{ margin-top:10px; max-height:60vh; overflow:auto; }
  #pf-results a{ display:block; padding:6px 0; color:#333; text-decoration:none; }
  #pf-results a:hover{ text-decoration:underline; }
</style>

<script>
  // サブディレクトリでも正しく読むための base
  const PF_BASE = new URL(document.baseURI).pathname;
  // 実際に読み込む pagefind.js の URL（base に依存）
  const PF_SRC  = new URL('pagefind/pagefind.js', document.baseURI).href;

  // pagefind.js を動的にロード
  function loadPagefind(){
    return new Promise((resolve, reject) => {
      if (typeof window.pagefind === 'function') return resolve(window.pagefind);
      const s = document.createElement('script');
      s.src = PF_SRC;
      s.onload = () => resolve(window.pagefind);
      s.onerror = (e) => reject(new Error('pagefind.js の読み込みに失敗: ' + PF_SRC));
      document.head.appendChild(s);
    });
  }

  // パネル生成など（あなたの ensurePanel / openPanel / closePanel はそのまま利用）
  function ensurePanel(){
    if (document.getElementById('pf-panel')) return;
    const panel = document.createElement('div');
    panel.id = 'pf-panel';
    panel.innerHTML = `
      <input id="pf-input" type="text" placeholder="サイト内検索…">
      <div id="pf-results"></div>
    `;
    document.body.appendChild(panel);
  }
  function openPanel(){ const p=document.getElementById('pf-panel'); p.style.display='block'; document.getElementById('pf-input').focus(); }
  function closePanel(){ const p=document.getElementById('pf-panel'); p.style.display='none'; }

  window.addEventListener('load', async () => {
    try {
      // 1) 動的ロード
      const pagefindFn = await loadPagefind();
      if (typeof pagefindFn !== 'function') {
        console.error('❌ pagefind.js 取得済みだが window.pagefind が関数ではありません');
        return;
      }

      // 2) UI 準備
      ensurePanel();
      const engine = await pagefindFn({ baseUrl: PF_BASE });

      // 3) 虫眼鏡トグル
      const trigger = document.querySelector('.header-search a');
      if (!trigger) { console.warn('⚠️ .header-search a が見つかりません'); return; }

      trigger.addEventListener('click', (e) => {
        e.preventDefault();
        const panel = document.getElementById('pf-panel');
        if (panel.style.display === 'block') { closePanel(); return; }
        openPanel();
        document.getElementById('pf-input').value = '';
        document.getElementById('pf-results').innerHTML = '';
      });

      // 4) 外側クリック/ESCで閉じる
      document.addEventListener('click', (e)=>{
        const p = document.getElementById('pf-panel');
        if (p.style.display !== 'block') return;
        if (!e.target.closest('#pf-panel') && !e.target.closest('.header-search')) closePanel();
      });
      document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closePanel(); });

      // 5) 入力→検索（デバウンス）
      let t;
      const input = document.getElementById('pf-input');
      const list  = document.getElementById('pf-results');
      input.addEventListener('input', ()=>{
        clearTimeout(t);
        t = setTimeout(async ()=>{
          const q = input.value.trim();
          list.innerHTML = '';
          if (!q) return;

          const res = await engine.search(q);
          if (!res?.results?.length){
            list.innerHTML = '<p>該当する結果はありません。</p>';
            return;
          }
          for (const r of res.results){
            const d = await r.data();
            const a = document.createElement('a');
            a.href = d.url;
            a.textContent = d.meta?.title || d.url;
            list.appendChild(a);
          }
        }, 160);
      });

      console.log('✅ Pagefind ready (dynamic)');
    } catch (e) {
      console.error(e);
    }
  });
</script>
