{{ warnf "USING_LOCAL_FOOTER" }}
<footer class="footer">
  <span>&copy; {{ now.Year }} <a href="{{ "" | absLangURL }}">{{ site.Title }}</a></span>
</footer>

<!-- ▼ Pagefind loader（必ず 1 行で読み込む） -->
<script src="{{ "pagefind/pagefind.js" | absURL }}"></script>

<style>
  /* フローティング検索パネル（ヘッダーを動かさない） */
  #pf-panel{
    position:fixed; z-index:9999; width:320px; max-width:calc(100vw - 24px);
    right:12px; top:72px; display:none; background:#fff; border-radius:12px;
    box-shadow:0 10px 28px rgba(0,0,0,.18); padding:12px;
  }
  #pf-panel input{ width:100%; padding:8px 10px; border:1px solid #ccc; border-radius:8px; outline:none; }
  #pf-results{ margin-top:10px; max-height:60vh; overflow:auto; }
  #pf-results a{ display:block; padding:6px 0; color:#333; text-decoration:none; }
  #pf-results a:hover{ text-decoration:underline; }
</style>

<script>
  // インデックスのベースURL（サブディレクトリ公開に対応）
  const PF_BASE = new URL(document.baseURI).pathname;

  // パネル生成（重複作成しない）
  function ensurePanel(){
    if (document.getElementById('pf-panel')) return;
    const panel = document.createElement('div');
    panel.id = 'pf-panel';
    panel.innerHTML = `
      <input id="pf-input" type="text" placeholder="サイト内検索…">
      <div id="pf-results"></div>
    `;
    document.body.appendChild(panel);
  }

  // パネルの表示位置は固定（ヘッダーを崩さない）
  function openPanel(){
    const p = document.getElementById('pf-panel');
    p.style.display = 'block';
    document.getElementById('pf-input').focus();
  }
  function closePanel(){
    const p = document.getElementById('pf-panel');
    p.style.display = 'none';
  }

  // 起動
  window.addEventListener('load', async () => {
    console.log('🔎 injecting pagefind…');

    // loader が本当に入ったかチェック
    if (typeof window.pagefind !== 'function') {
      console.error('❌ pagefind.js が読み込めていません（HTML に <script src="/…/pagefind/pagefind.js"> が無い）');
      return;
    }

    ensurePanel();

    // Pagefind エンジン作成
    const engine = await window.pagefind({ baseUrl: PF_BASE });

    // 既存の虫眼鏡アイコンに紐付け（PaperMod の .header-search a）
    const trigger = document.querySelector('.header-search a');
    if (!trigger) { console.warn('⚠️ .header-search a が見つかりません'); return; }

    trigger.addEventListener('click', (e) => {
      e.preventDefault();
      const p = document.getElementById('pf-panel');
      if (p.style.display === 'block') { closePanel(); return; }
      openPanel();
      document.getElementById('pf-input').value = '';
      document.getElementById('pf-results').innerHTML = '';
    });

    // 外側クリック / Esc で閉じる
    document.addEventListener('click', (e)=>{
      const p = document.getElementById('pf-panel');
      if (p.style.display !== 'block') return;
      if (!e.target.closest('#pf-panel') && !e.target.closest('.header-search')) closePanel();
    });
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closePanel(); });

    // 入力 → 検索
    let t; 
    const input  = document.getElementById('pf-input');
    const list   = document.getElementById('pf-results');
    input.addEventListener('input', ()=>{
      clearTimeout(t);
      t = setTimeout(async ()=>{
        const q = input.value.trim();
        list.innerHTML = '';
        if (!q) return;

        const res = await engine.search(q);
        if (!res?.results?.length){ list.innerHTML = '<p>該当する結果はありません。</p>'; return; }
        for (const r of res.results){
          const d = await r.data();
          const a = document.createElement('a');
          a.href = d.url; a.textContent = d.meta?.title || d.url;
          list.appendChild(a);
        }
      }, 160);
    });

    console.log('✅ Pagefind ready');
  });
</script>
